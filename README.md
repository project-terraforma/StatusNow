# StatusNow - Place Status Classification

This project aims to classify whether a place (POI) is Open or Closed based on its metadata and derived mobility signals.

## Data

- `data/Season 2 Samples 3k Project Updated.parquet`: The dataset containing place samples with a balanced distribution (~60% Open / 40% Closed).
- `data/processed_with_mobility.parquet`: The intermediate dataset containing Geocoded POIs and Mobility Scores (from Fused).
- `data/processed_for_ml.parquet`: The final processed dataset with all engineering features (generated by `process_data.py`).

### Final Schema (for Machine Learning)

The `processed_for_ml.parquet` file contains the following engineered features used to train the model:

| Column Name                | Type  | Description                                                                       |
| :------------------------- | :---- | :-------------------------------------------------------------------------------- |
| **Label**                  |       |                                                                                   |
| `open`                     | int64 | Target variable (1 = Open, 0 = Closed).                                           |
| **Mobility & Geocoding**   |       |                                                                                   |
| `mobility_score`           | float | **NEW**. Normalized foot-traffic activity (Intensity / Sources).                  |
| `is_ghost_candidate`       | int64 | **NEW**. Flag for valid metadata (>2 sources) but zero activity.                  |
| **Recency & Sources**      |       |                                                                                   |
| `days_since_latest_update` | int   | Days since the most recent source update (e.g., Meta/Msft update time).           |
| `avg_days_since_update`    | float | Average age of all source records.                                                |
| `num_sources`              | int   | Total count of datasets verifying this place (e.g., Meta + Microsoft = 2).        |
| `source_has_msft`          | int   | 1 if 'Microsoft' is a source provider (High quality signal).                      |
| `is_cross_verified`        | int   | 1 if the place appears in multiple independent datasets.                          |
| **Digital Presence**       |       |                                                                                   |
| `has_website`              | int   | 1 if a website URL is present.                                                    |
| `has_social`               | int   | 1 if any social media link is present.                                            |
| `has_phone`                | int   | 1 if a phone number is present.                                                   |
| `contact_depth`            | int   | Sum of websites, socials, and emails (richness of contact info).                  |
| `len_socials`              | int   | Count of social media handles.                                                    |
| `has_facebook`             | int   | 1 if a Facebook URL is detected.                                                  |
| `has_instagram`            | int   | 1 if an Instagram URL is detected.                                                |
| `has_conflicting_websites` | int   | 1 if multiple distinct domain names are listed (potential confusion/closure).     |
| **Metadata**               |       |                                                                                   |
| `confidence`               | float | Overture's internal confidence score (0.0 - 1.0).                                 |
| `is_brand`                 | int   | 1 if the place is associated with a known brand chain.                            |
| `cat_is_unknown`           | int   | 1 if the primary category is missing or 'unknown'.                                |
| **Categories (One-Hot)**   | bool  | Specific category flags (e.g., `cat_hotel`, `cat_restaurant`, `cat_gas_station`). |

## Scripts

- **`read_data.py`**: Reads and displays the raw parquet data schema and first few rows.
- **`inspect_data.py`**: Performs deep inspection of the data, checking for valid IDs, class balance, and feature correlations.
- **`enrich_with_fused.py`**: **NEW**. Geocodes addresses to Lat/Lon (via OSM) and simulates/fetches mobility data using Fused.io. Adds `mobility_score` and `is_ghost_candidate`.
- **`process_data.py`**: The main ETL script. It reads the data (preferring enriched), parses JSON fields, creates features (Confidence, One-Hot Categories, Recency, Social Platforms, Mobility), and saves the result to `data/processed_for_ml.parquet`.
- **`experiment_runner.py`**: Runs 5-Fold Cross Validation on multiple models (Balanced Random Forest, XGBoost) and reports metrics.

## Setup

```bash
# Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install dependencies (Standard + Spatial)
pip install duckdb pandas numpy pyarrow scikit-learn imbalanced-learn xgboost fused geopandas shapely requests tqdm
```

## Usage

1. Inspect the raw data:
   ```bash
   python3 read_data.py
   python3 inspect_data.py
   ```
2. Enrich Data (Geocoding + Mobility):
   ```bash
   # This runs geocoding (takes time) and adds mobility_score
   python3 enrich_with_fused.py
   ```
3. Generate features:
   ```bash
   python3 process_data.py
   ```
4. Run Model Experiments:
   ```bash
   python3 experiment_runner.py
   ```

## Model Experiments & Findings

We compared **Balanced Random Forest** vs **XGBoost** to predict if a place is closed based on static metadata, including new **Recency**, **Social Platform**, and **Mobility** features.

### Results (Balanced Accuracy)

| Model            | Balanced Acc | Performance Analysis                                                                                                            |
| :--------------- | :----------- | :------------------------------------------------------------------------------------------------------------------------------ |
| **CatBoost**     | **66.64%**   | **SOTA**. The current leader. Handles the mix of sparse mobility data and categorical features natively with Gradient Boosting. |
| **EasyEnsemble** | 66.21%       | **Strong**. Boosting + Bagging technique ties with XGBoost, showing robust recall for the minority class (Closed).              |
| **XGBoost**      | 66.17%       | **Restored**. After tuning hyperparameters (`scale_pos_weight=1`, `max_depth=5`), it performs on par with EasyEnsemble.         |
| **Balanced RF**  | 65.03%       | **Baseline**. Consistent performance but trails the boosting methods.                                                           |

### Key Insights

1.  **Ensemble Dominance**: Gradient Boosting (CatBoost, XGBoost) and Bagging (EasyEnsemble) all converge around the **66%** mark, confirming this as the likely data ceiling.
2.  **CatBoost Advantage**: CatBoost's native handling of categorical data and robust defaults make it the most reliable choice for this specific dataset.
3.  **Mobility & Geocoding**: The process of geocoding addresses and checking for mobility proved valuable. Places that couldn't be geocoded or had zero extrapolated activity were more likely to be Closed.
4.  **Recency Matters**: "Days Since Last Update" remains a critical differentiator.
5.  **Ceiling**: We typically see a ceiling around **66-67%** with static data. This suggests that ~1/3 of "Closed" places look identical to "Open" places on paper (Zombie POIs). Dynamic verification is the next logical step.
