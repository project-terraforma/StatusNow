# StatusNow - Place Status Classification

This project aims to classify whether a place (POI) is Open or Closed based on its metadata and derived mobility signals.

## Data

- `data/Season 2 Samples 3k Project Updated.parquet`: **PRIMARY DATASET** (10/90 split). Contains 3,000 place samples with baseline comparison data (~60% Open / 40% Closed).
- `data/Project C Samples.parquet`: Alternative dataset (60/40 split, 3,425 rows) from a different assignment. Can be used if helpful.
- `data/processed_for_ml.parquet`: The final processed dataset with all engineered features including **delta features** (generated by `process_data.py`).

### Final Schema (for Machine Learning)

The `processed_for_ml.parquet` file contains the following engineered features used to train the model:

| Column Name                              | Type  | Description                                                                       |
| :--------------------------------------- | :---- | :-------------------------------------------------------------------------------- |
| **Label**                                |       |                                                                                   |
| `open`                                   | int64 | Target variable (1 = Open, 0 = Closed).                                           |
| **Delta Features (Baseline vs Current)** |       | **NEW**. Captures CHANGE in digital presence over time.                           |
| `delta_confidence`                       | float | Change in confidence score (baseline â†’ current).                                  |
| `delta_num_websites`                     | int   | Net change in website count.                                                      |
| `delta_num_socials`                      | int   | Net change in social media links. **Strong predictor** (r=+0.18).                 |
| `delta_num_phones`                       | int   | Net change in phone numbers.                                                      |
| `has_lost_website`                       | int   | 1 if lost at least one website (22% of closed vs 13% of open).                    |
| `has_gained_website`                     | int   | 1 if gained at least one website.                                                 |
| `has_lost_social`                        | int   | 1 if lost social media presence (59% of closed vs 45% of open).                   |
| `has_gained_social`                      | int   | **STRONGEST PREDICTOR** (r=+0.26). 1 if gained social media.                      |
| `has_lost_phone`                         | int   | 1 if lost phone number.                                                           |
| `has_gained_phone`                       | int   | 1 if gained phone number.                                                         |
| `delta_total_contact`                    | int   | Total change across all contact methods. **Strong indicator** (r=+0.19).          |
| `has_any_loss`                           | int   | 1 if lost ANY digital presence. **Strong closure signal** (r=-0.17).              |
| **Recency & Sources**                    |       |                                                                                   |
| `days_since_latest_update`               | int   | Days since the most recent source update (e.g., Meta/Msft update time).           |
| `avg_days_since_update`                  | float | Average age of all source records.                                                |
| `num_sources`                            | int   | Total count of datasets verifying this place (e.g., Meta + Microsoft = 2).        |
| `source_has_msft`                        | int   | 1 if 'Microsoft' is a source provider (High quality signal).                      |
| `is_cross_verified`                      | int   | 1 if the place appears in multiple independent datasets.                          |
| **Digital Presence**                     |       |                                                                                   |
| `has_website`                            | int   | 1 if a website URL is present.                                                    |
| `has_social`                             | int   | 1 if any social media link is present.                                            |
| `has_phone`                              | int   | 1 if a phone number is present.                                                   |
| `contact_depth`                          | int   | Sum of websites, socials, and emails (richness of contact info).                  |
| `len_socials`                            | int   | Count of social media handles.                                                    |
| `has_facebook`                           | int   | 1 if a Facebook URL is detected.                                                  |
| `has_instagram`                          | int   | 1 if an Instagram URL is detected.                                                |
| `has_conflicting_websites`               | int   | 1 if multiple distinct domain names are listed (potential confusion/closure).     |
| **Metadata**                             |       |                                                                                   |
| `confidence`                             | float | Overture's internal confidence score (0.0 - 1.0).                                 |
| `is_brand`                               | int   | 1 if the place is associated with a known brand chain.                            |
| `cat_is_unknown`                         | int   | 1 if the primary category is missing or 'unknown'.                                |
| **Categories (One-Hot)**                 | bool  | Specific category flags (e.g., `cat_hotel`, `cat_restaurant`, `cat_gas_station`). |

## Scripts

- **`read_data.py`**: Reads and displays the raw parquet data schema and first few rows.
- **`inspect_data.py`**: Performs deep inspection of the data, checking for valid IDs, class balance, and feature correlations.
- **`process_data.py`**: The main ETL script. Reads Season 2 dataset, parses JSON fields, creates features (Confidence, One-Hot Categories, Recency, Social Platforms, **Delta Features**), and saves the result to `data/processed_for_ml.parquet`.
- **`experiment_runner.py`**: Runs 5-Fold Cross Validation on multiple models (Logistic Regression, Balanced RF, XGBoost, CatBoost, EasyEnsemble) and reports metrics.
- **`analyze_delta_features.py`**: **NEW**. Analyzes the predictive power of delta features by computing correlations and distribution differences.
- **`feature_selection.py`**: **NEW**. Identifies redundant/low-importance features and finds optimal feature subset (30 features) to avoid overfitting.

## Setup

```bash
# Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install dependencies (Standard + Spatial)
pip install duckdb pandas numpy pyarrow scikit-learn imbalanced-learn xgboost fused geopandas shapely requests tqdm
```

## Usage

1. Inspect the raw data:
   ```bash
   python3 read_data.py
   python3 inspect_data.py
   ```
2. Analyze Delta Features (Optional):
   ```bash
   # Analyze the predictive power of delta features
   python3 analyze_delta_features.py
   ```
3. Generate features:
   ```bash
   python3 process_data.py
   ```
4. Run Model Experiments:
   ```bash
   python3 experiment_runner.py
   ```

## Model Experiments & Findings

We trained multiple models to predict if a place is closed, using **delta features** (baseline vs current comparison) alongside metadata, recency, and digital presence signals.

### Dataset Information

- **Primary**: Season 2 Samples 3k (10/90 split) - 3,000 rows
- **Features**: 49 total (including 12 delta features)
- **Class Balance**: 60.3% Open, 39.7% Closed
- **Key Innovation**: Delta features comparing baseline historical data with current data

### Results (5-Fold Cross Validation)

| Model                   | ROC AUC    | Balanced Acc | F1 Macro   | Precision (Closed) | Recall (Closed) | Time (s) |
| :---------------------- | :--------- | :----------- | :--------- | :----------------- | :-------------- | :------- |
| **CatBoost** â­         | 0.7559     | **0.6731**   | **0.6645** | 0.5726             | 0.6834          | 1.83     |
| **XGBoost**             | **0.7601** | 0.6599       | 0.6629     | **0.6720**         | 0.4702          | 1.02     |
| **Logistic Regression** | 0.7323     | 0.6659       | 0.6502     | 0.5903             | **0.7221**      | 1.42     |
| Balanced RF             | 0.7382     | 0.6548       | 0.6366     | 0.5315             | 0.7380          | 1.92     |
| EasyEnsemble            | 0.7181     | 0.6502       | 0.6384     | 0.5423             | 0.6868          | 2.74     |

### Key Insights

1. **Delta Features are Powerful**: The 12 new delta features (comparing baseline vs current data) significantly improved model performance.
   - **`has_gained_social`** (r=+0.26) - Strongest single predictor! Places that gained social media are much more likely to be open.
   - **`has_any_loss`** (r=-0.17) - Strong closure signal. 64% of closed places lost digital presence vs 47% of open places.
   - **`delta_total_contact`** (r=+0.19) - Overall digital footprint change is highly predictive.

2. **CatBoost Wins Overall**: Best balanced accuracy (67.3%) with good balance between precision and recall. Recommended for deployment.

3. **XGBoost Has Best Discrimination**: Highest ROC AUC (0.76) and precision (0.67), but lower recall. Good if minimizing false positives is critical.

4. **Logistic Regression Performs Well**: Surprisingly competitive (66.6% balanced accuracy) with excellent interpretability. Great baseline and for understanding feature importance.

5. **Generalizability**: Model uses NO mobility data, making it applicable to any location worldwide with Overture Maps data.

6. **Performance Ceiling**: ~67% balanced accuracy suggests that some closed places are indistinguishable from open ones using static metadata alone. The delta features help capture temporal changes that indicate closure.

### Top Predictive Features

1. `has_gained_social` (+0.26 correlation) - Gained social media â†’ Open
2. `delta_total_contact` (+0.19) - Positive contact info change â†’ Open
3. `delta_num_socials` (+0.18) - More social media â†’ Open
4. `has_any_loss` (-0.17) - Lost any digital presence â†’ Closed
5. `delta_confidence` (+0.17) - Confidence increase â†’ Open

### Feature Selection Analysis

To avoid overfitting (49 features on 3,000 samples), we performed feature selection analysis:

**Key Findings:**

- âš ï¸ **7 near-zero variance features** found (e.g., `has_instagram`, `has_conflicting_websites`)
- âš ï¸ **15 highly correlated pairs** (r > 0.9) indicating redundancy:
  - `has_social` â†” `has_facebook` (r=1.0) - perfectly correlated
  - `has_social` â†” `len_socials` (r=1.0) - redundant
  - `has_website` â†” `has_lost_website` (r=-0.94) - inverse relationship
  - `days_since_latest_update` â†” `avg_days_since_update` (r=0.97) - highly redundant

**Optimal Feature Set: 30 features** ðŸŽ¯

- **Performance**: 0.6782 balanced accuracy (vs 0.6738 with 48 features)
- **Improvement**: +0.43% by removing 18 redundant/low-importance features
- **Reduced overfitting**: Better generalization with fewer features

**Top 10 Most Important Features (by Random Forest):**

1. `avg_days_since_update` (14.6%)
2. `delta_confidence` (12.5%)
3. `days_since_latest_update` (10.5%)
4. `confidence` (9.8%)
5. `num_sources` (5.6%)
6. `delta_num_socials` (4.6%)
7. `delta_total_contact` (3.6%)
8. `is_brand` (3.2%)
9. `cat_other` (3.1%)
10. `source_has_msft` (3.0%)

**Features to Remove (9 lowest importance):**

- `has_instagram`, `has_conflicting_websites` (zero variance/importance)
- `has_gained_phone`, `has_lost_phone`, `delta_num_phones` (phones rarely change)
- `has_lost_website`, `has_gained_website` (redundant with delta features)
- Category features: `cat_landmark_and_historical_building`, `cat_automotive_repair`

See `recommended_features.txt` for the complete 30-feature list.

### Recommendations

- **For Production**: Use CatBoost with **30 selected features** (best performance + reduced overfitting)
- **For Interpretability**: Use Logistic Regression (transparent coefficients)
- **For Precision**: Use XGBoost (fewer false alarms)
